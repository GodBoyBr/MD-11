<?xml version="1.0"?>

<!-- McDonnell Douglas MD-11 GE CF6-80C2D1F FADEC -->
<!-- Copyright (c) 2020 Josh Davidson (Octal450) -->

<system name="MD-11: FADEC GE">
	
	<property value="1">fadec/limit/packs-off</property>
	<property value="0">fadec/limit/flex-active</property>
	<property value="30">fadec/limit/flex-temp</property>
	
	<channel name="Thrust Limits">
		
		<fcs_function name="fadec/limit/rated-thrust-n1"> <!-- Not 100% sure on this -->
			<function>
				<table>
					<independentVar lookup="row">/position/altitude-ft</independentVar>
					<independentVar lookup="column">propulsion/tat-c</independentVar>
					<tableData>
						      -60    -30     0      30     60
						    0   94.9  100.9  106.4  111.7  106.2
						10000  101.4  105.5  111.3  112.9  108.1
						43000  101.4  101.8  107.5  113.2  110.8
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/milthrust-unmodified"> <!-- Copy of MilThrust table in engines file -->
			<function>
				<table>
					<independentVar lookup="row">velocities/mach</independentVar>
					<independentVar lookup="column">atmosphere/density-altitude</independentVar>
					<tableData>
						     -10000   0       10000   20000   30000   43000   50000
						0.0   1.2600  1.0000  0.7400  0.5640  0.3920  0.2710  0.0000
						0.2   1.1710  0.9740  0.6970  0.5360  0.3850  0.2610  0.0000
						0.4   1.1500  0.9570  0.6920  0.5460  0.3870  0.2530  0.0000
						0.6   1.1810  0.9410  0.7210  0.5660  0.3580  0.2180  0.0000
						0.8   1.2290  1.0200  0.7820  0.5570  0.3040  0.1930  0.0000
						0.9   1.2580  1.0200  0.7820  0.5220  0.2710  0.1140  0.0000
						1.0   1.1810  0.9510  0.7210  0.4410  0.1740  0.0450  0.0000
						1.2   0.0000  0.0000  0.0000  0.0000  0.0000  0.0000  0.0000
						1.4   0.0000  0.0000  0.0000  0.0000  0.0000  0.0000  0.0000
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<!-- Following functions fix a FGTurbine inaccuracy... rated thrust N1% should be rated thrust lbs -->
		<!-- These calculations change it so that the rated power at sea level is at the correct N1% value. It still changes with altitude and mach as it should -->
		<fcs_function name="fadec/limit/fgturbine-thrust-lbs">
			<function>
				<sum>
					<product>
						<property>propulsion/engine/IdleThrust</property>
						<value>61960</value>
					</product>
					<product>
						<difference>
							<value>61960</value>
							<product>
								<property>propulsion/engine[0]/IdleThrust</property> <!-- It doesn't matter which engine, its same for all -->
								<value>61960</value>
							</product>
						</difference>
						<property>fadec/limit/milthrust-unmodified</property>
					</product>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/rated-thrust-lbs">
			<function>
				<sum>
					<product>
						<property>propulsion/engine/IdleThrust</property>
						<value>61960</value>
					</product>
					<product>
						<product>
							<difference>
								<value>61960</value>
								<product>
									<property>propulsion/engine[0]/IdleThrust</property> <!-- It doesn't matter which engine, its same for all -->
									<value>61960</value>
								</product>
							</difference>
							<property>fadec/limit/milthrust-unmodified</property>
						</product>
						<quotient>
							<difference>
								<property>fadec/limit/rated-thrust-n1</property>
								<value>23.7</value>
							</difference>
							<value>93.8</value>
						</quotient>
						<quotient>
							<difference>
								<property>fadec/limit/rated-thrust-n1</property>
								<value>23.7</value>
							</difference>
							<value>93.8</value>
						</quotient>
					</product>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/rated-thrust-factor"> <!-- Normalize -->
			<function>
				<ifthen>
					<nq> <!-- Prevent divide by 0 -->
						<property>fadec/limit/rated-thrust-lbs</property>
						<value>0</value>
					</nq>
					<quotient>
						<property>fadec/limit/fgturbine-thrust-lbs</property>
						<property>fadec/limit/rated-thrust-lbs</property>
					</quotient>
					<value>1</value>
				</ifthen>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/go-around">
			<function>
				<quotient>
					<integer>
						<sum>
							<product>
								<property>fadec/limit/rated-thrust-n1</property>
								<value>10</value>
							</product>
							<value>0.5</value> <!-- Make it round correctly -->
						</sum>
					</integer>
					<value>10</value>
				</quotient>
			</function>
		</fcs_function>
		
		<switch name="fadec/limit/to-ref-temp">
			<default value="propulsion/tat-c"/>
			<test value="fadec/limit/flex-temp">
				fadec/limit/flex-active eq 1
			</test>
		</switch>
		
		<fcs_function name="fadec/limit/takeoff-ref"> <!-- From FCOM -->
			<function>
				<sum>
					<table>
						<independentVar lookup="row">/position/altitude-ft</independentVar>
						<independentVar lookup="column">fadec/limit/to-ref-temp</independentVar>
						<tableData>
							      -30    -20    -10     0      10     20     30     40     50
							-1000   98.9  100.7  102.5  104.3  106.1  107.8  109.6  108.7  107.0
							    0  100.5  102.4  104.2  106.0  107.8  109.6  111.4  109.5  107.5
							 1000  101.2  103.1  104.9  106.8  108.5  110.3  111.4  109.5  107.4
							 2000  101.9  103.8  105.6  107.5  109.2  111.0  111.3  109.4  107.3
							 3000  102.7  104.5  106.4  108.2  110.0  111.8  111.3  109.2  107.3
							 4000  103.4  105.3  107.1  108.9  110.7  112.4  111.3  109.0  107.5
							 5000  104.2  106.0  107.9  109.6  111.4  113.2  111.2  108.8  107.5
							 6000  104.9  106.8  108.6  110.3  112.1  113.3  111.3  108.9  107.6
							 7000  105.8  107.7  109.5  111.3  113.1  113.2  111.1  108.9  107.6
							 8000  106.6  108.5  110.4  112.2  114.0  113.1  110.8  108.9  107.6
							 9000  107.0  109.0  110.9  112.7  114.4  113.0  110.8  109.0  107.7
							10000  107.5  109.5  111.4  113.2  114.9  112.9  110.8  109.2  107.9
						</tableData>
					</table>
					<product>
						<table>
							<independentVar lookup="row">/position/altitude-ft</independentVar>
							<tableData>
								    0  0.3
								 2000  0.4
								 4000  0.4
								 6000  0.3
								 8000  0.4
								10000  0.4
							</tableData>
						</table>
						<property>fadec/limit/packs-off</property>
					</product>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/takeoff">
			<function>
				<quotient>
					<integer>
						<sum>
							<product>
								<property>fadec/limit/takeoff-ref</property>
								<value>10</value>
							</product>
							<value>0.5</value> <!-- Make it round correctly -->
						</sum>
					</integer>
					<value>10</value>
				</quotient>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/mct-ref">
			<function>
				<table>
					<independentVar lookup="row">/position/altitude-ft</independentVar>
					<independentVar lookup="column">propulsion/tat-c</independentVar>
					<tableData>
						      -60    -30     0      30     60
						    0   92.0   92.0   97.4  102.4  104.6
						10000   99.5   99.5  104.9  108.1  104.7
						43000  106.0  106.9  104.6  109.2  110.3
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/mct">
			<function>
				<quotient>
					<integer>
						<sum>
							<product>
								<property>fadec/limit/mct-ref</property>
								<value>10</value>
							</product>
							<value>0.5</value> <!-- Make it round correctly -->
						</sum>
					</integer>
					<value>10</value>
				</quotient>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/climb-ref">
			<function>
				<table>
					<independentVar lookup="row">/position/altitude-ft</independentVar>
					<independentVar lookup="column">propulsion/tat-c</independentVar>
					<tableData>
						      -60    -30     0      30     60
						    0   89.9   89.9   95.2  100.2  98.1
						10000   97.9   97.9  103.2  104.5  98.1
						43000  102.6  103.2  102.6  103.1  98.1
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/climb">
			<function>
				<quotient>
					<integer>
						<sum>
							<product>
								<property>fadec/limit/climb-ref</property>
								<value>10</value>
							</product>
							<value>0.5</value> <!-- Make it round correctly -->
						</sum>
					</integer>
					<value>10</value>
				</quotient>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/cruise-ref">
			<function>
				<table>
					<independentVar lookup="row">/position/altitude-ft</independentVar>
					<independentVar lookup="column">propulsion/tat-c</independentVar>
					<tableData>
						      -60   -30    0      30    60
						    0  85.8  85.8  90.9  95.7  93.7
						10000  93.5  93.5  98.6  99.8  93.7
						43000  98.0  98.8  97.9  98.5  93.7
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/cruise">
			<function>
				<quotient>
					<integer>
						<sum>
							<product>
								<property>fadec/limit/cruise-ref</property>
								<value>10</value>
							</product>
							<value>0.5</value> <!-- Make it round correctly -->
						</sum>
					</integer>
					<value>10</value>
				</quotient>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/idle-ref">
			<function>
				<ifthen>
					<eq>
						<property>/gear/gear[0]/wow</property>
						<value>0</value>
					</eq>
					<table>
						<independentVar lookup="row">velocities/mach</independentVar>
						<independentVar lookup="column">/controls/flight/flaps-input</independentVar>
						<independentVar lookup="table">/position/altitude-ft</independentVar>
						<tableData breakPoint="0">
							      0     1
							0.21  30.3  39.3
							0.70  45.1  49.1
						</tableData>
						<tableData breakPoint="43000">
							      0     1
							0.55  52.1  59.1
							0.90  62.4  65.4
						</tableData>
					</table>
					<value>0</value>
				</ifthen>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/idle">
			<function>
				<quotient>
					<integer>
						<sum>
							<product>
								<property>fadec/limit/idle-ref</property>
								<value>10</value>
							</product>
							<value>0.5</value> <!-- Make it round correctly -->
						</sum>
					</integer>
					<value>10</value>
				</quotient>
			</function>
		</fcs_function>
	
	</channel>
	
	<channel name="Engine Control">
		
		<fcs_function name="fadec/limit/active-norm">
			<function>
				<table>
					<independentVar lookup="row">fadec/limit/active</independentVar> <!-- Selected by nasal -->
					<tableData>
						 23.7  0
						117.5  1
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/ga-mct-max">
			<function>
				<max> <!-- Sometimes G/A is higher than MCT -->
					<property>fadec/limit/go-around</property>
					<property>fadec/limit/mct</property>
				</max>
			</function>
		</fcs_function>
		
		<switch name="fadec/limit/max-throttle-n1">
			<default value="fadec/limit/ga-mct-max"/>
			<test value="fadec/limit/takeoff"> <!-- Should be based on FMS State in state before Climb -->
				fadec/limit/active-mode-int eq 0
			</test>
		</switch>
		
		<fcs_function name="fadec/limit/max-throttle-n1-norm">
			<function>
				<table>
					<independentVar lookup="row">fadec/limit/max-throttle-n1</independentVar>
					<tableData>
						 23.7  0
						117.5  1
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/idle-norm">
			<function>
				<table>
					<independentVar lookup="row">fadec/limit/idle</independentVar>
					<tableData>
						 23.7  0
						117.5  1
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<!-- Engine 1 -->
		<switch name="fadec/control-1/max">
			<default value="fadec/limit/max-throttle-n1-norm"/>
			<test value="1">
				/controls/fadec/eng-1-altn eq 1
			</test>
		</switch>
		
		<switch name="fadec/control-1/min">
			<default value="fadec/limit/idle-norm"/>
			<test value="0">
				/controls/fadec/eng-1-altn eq 1
			</test>
		</switch>
		
		<switch name="fadec/control-1/throttle-pos">
			<default value="/controls/engines/engine[0]/throttle"/>
			<test value="0">
				/controls/engines/engine[0]/reverser ne 0
			</test>
			<test logic="AND" value="fadec/ats-cmd-1">
				/it-autoflight/output/athr eq 1
				/it-autoflight/output/clamp eq 0
			</test>
			<clipto>
				<min>0</min> <!-- Intentional -->
				<max>fadec/control-1/max</max>
			</clipto>
		</switch>
		
		<switch name="fadec/control-1/throttle-n1-cmd">
			<default value="fadec/control-1/throttle-pos"/>
			<test value="fadec/control-1/throttle-rev">
				/controls/engines/engine[0]/reverser ne 0
			</test>
		</switch>
		
		<lag_filter name="fadec/control-1/throttle-n1-lag">
			<input>fadec/control-1/throttle-n1-cmd</input>
			<c1>20</c1>
		</lag_filter>
		
		<fcs_function name="fadec/control-1/throttle-n1">
			<function>
				<table>
					<independentVar lookup="row">fadec/control-1/throttle-n1-lag</independentVar>
					<tableData>
						0   23.7
						1  117.5
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<pure_gain name="fadec/control-1/throttle-pos-clamped">
			<input>fadec/control-1/throttle-pos</input>
			<gain>1.0</gain>
			<clipto>
				<min>fadec/control-1/min</min>
				<max>fadec/control-1/max</max>
			</clipto>
		</pure_gain>
		
		<switch name="fadec/control-1/throttle-output">
			<default value="fadec/control-1/throttle-pos-clamped"/>
			<test value="fadec/control-1/throttle-rev">
				/controls/engines/engine[0]/reverser ne 0
			</test>
		</switch>
		
		<lag_filter name="fcs/control-1/throttle-fdm">
			<input>fadec/control-1/throttle-output</input>
			<c1>0.75</c1>
			<output>fcs/throttle-pos-norm[0]</output>
		</lag_filter>
		
		<!-- Engine 2 -->
		<switch name="fadec/control-2/max">
			<default value="fadec/limit/max-throttle-n1-norm"/>
			<test value="1">
				/controls/fadec/eng-2-altn eq 1
			</test>
		</switch>
		
		<switch name="fadec/control-2/min">
			<default value="fadec/limit/idle-norm"/>
			<test value="0">
				/controls/fadec/eng-2-altn eq 1
			</test>
		</switch>
		
		<switch name="fadec/control-2/throttle-pos">
			<default value="/controls/engines/engine[1]/throttle"/>
			<test value="0">
				/controls/engines/engine[1]/reverser ne 0
			</test>
			<test logic="AND" value="fadec/ats-cmd-2">
				/it-autoflight/output/athr eq 1
				/it-autoflight/output/clamp eq 0
			</test>
			<clipto>
				<min>0</min> <!-- Intentional -->
				<max>fadec/control-2/max</max>
			</clipto>
		</switch>
		
		<switch name="fadec/control-2/throttle-n1-cmd">
			<default value="fadec/control-2/throttle-pos"/>
			<test value="fadec/control-2/throttle-rev">
				/controls/engines/engine[1]/reverser ne 0
			</test>
		</switch>
		
		<lag_filter name="fadec/control-2/throttle-n1-lag">
			<input>fadec/control-2/throttle-n1-cmd</input>
			<c1>20</c1>
		</lag_filter>
		
		<fcs_function name="fadec/control-2/throttle-n1">
			<function>
				<table>
					<independentVar lookup="row">fadec/control-2/throttle-n1-lag</independentVar>
					<tableData>
						0   23.7
						1  117.5
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<pure_gain name="fadec/control-2/throttle-pos-clamped">
			<input>fadec/control-2/throttle-pos</input>
			<gain>1.0</gain>
			<clipto>
				<min>fadec/control-2/min</min>
				<max>fadec/control-2/max</max>
			</clipto>
		</pure_gain>
		
		<switch name="fadec/control-2/throttle-output">
			<default value="fadec/control-2/throttle-pos-clamped"/>
			<test value="fadec/control-2/throttle-rev">
				/controls/engines/engine[1]/reverser ne 0
			</test>
		</switch>
		
		<lag_filter name="fcs/control-2/throttle-fdm">
			<input>fadec/control-2/throttle-output</input>
			<c1>0.75</c1>
			<output>fcs/throttle-pos-norm[1]</output>
		</lag_filter>
		
		<!-- Engine 3 -->
		<switch name="fadec/control-3/max">
			<default value="fadec/limit/max-throttle-n1-norm"/>
			<test value="1">
				/controls/fadec/eng-3-altn eq 1
			</test>
		</switch>
		
		<switch name="fadec/control-3/min">
			<default value="fadec/limit/idle-norm"/>
			<test value="0">
				/controls/fadec/eng-3-altn eq 1
			</test>
		</switch>
		
		<switch name="fadec/control-3/throttle-pos">
			<default value="/controls/engines/engine[2]/throttle"/>
			<test value="0">
				/controls/engines/engine[2]/reverser ne 0
			</test>
			<test logic="AND" value="fadec/ats-cmd-3">
				/it-autoflight/output/athr eq 1
				/it-autoflight/output/clamp eq 0
			</test>
			<clipto>
				<min>0</min> <!-- Intentional -->
				<max>fadec/control-3/max</max>
			</clipto>
		</switch>
		
		<switch name="fadec/control-3/throttle-n1-cmd">
			<default value="fadec/control-3/throttle-pos"/>
			<test value="fadec/control-3/throttle-rev">
				/controls/engines/engine[2]/reverser ne 0
			</test>
		</switch>
		
		<lag_filter name="fadec/control-3/throttle-n1-lag">
			<input>fadec/control-3/throttle-n1-cmd</input>
			<c1>20</c1>
		</lag_filter>
		
		<fcs_function name="fadec/control-3/throttle-n1">
			<function>
				<table>
					<independentVar lookup="row">fadec/control-3/throttle-n1-lag</independentVar>
					<tableData>
						0   23.7
						1  117.5
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<pure_gain name="fadec/control-3/throttle-pos-clamped">
			<input>fadec/control-3/throttle-pos</input>
			<gain>1.0</gain>
			<clipto>
				<min>fadec/control-3/min</min>
				<max>fadec/control-3/max</max>
			</clipto>
		</pure_gain>
		
		<switch name="fadec/control-3/throttle-output">
			<default value="fadec/control-3/throttle-pos-clamped"/>
			<test value="fadec/control-3/throttle-rev">
				/controls/engines/engine[2]/reverser ne 0
			</test>
		</switch>
		
		<lag_filter name="fcs/control-3/throttle-fdm">
			<input>fadec/control-3/throttle-output</input>
			<c1>0.75</c1>
			<output>fcs/throttle-pos-norm[2]</output>
		</lag_filter>
	
	</channel>
	
	<channel name="Engine Parameters" execrate="2">
		
		<lag_filter name="fadec/n1-actual1">
			<input>/engines/engine[0]/n1</input>
			<c1>2.25</c1>
			<output>/engines/engine[0]/n1-actual</output>
			<output>/engines/engine[4]/n1</output>
		</lag_filter>
		
		<lag_filter name="fadec/n1-actual2">
			<input>/engines/engine[1]/n1</input>
			<c1>2.25</c1>
			<output>/engines/engine[1]/n1-actual</output>
			<output>/engines/engine[5]/n1</output>
		</lag_filter>
		
		<lag_filter name="fadec/n1-actual3">
			<input>/engines/engine[2]/n1</input>
			<c1>2.25</c1>
			<output>/engines/engine[2]/n1-actual</output>
			<output>/engines/engine[6]/n1</output>
		</lag_filter>
		
		<lag_filter name="fadec/n2-actual1">
			<input>/engines/engine[0]/n2</input>
			<c1>2.25</c1>
			<output>/engines/engine[0]/n2-actual</output>
			<output>/engines/engine[4]/n2</output>
		</lag_filter>
		
		<lag_filter name="fadec/n2-actual2">
			<input>/engines/engine[1]/n2</input>
			<c1>2.25</c1>
			<output>/engines/engine[1]/n2-actual</output>
			<output>/engines/engine[5]/n2</output>
		</lag_filter>
		
		<lag_filter name="fadec/n2-actual3">
			<input>/engines/engine[2]/n2</input>
			<c1>2.25</c1>
			<output>/engines/engine[2]/n2-actual</output>
			<output>/engines/engine[6]/n2</output>
		</lag_filter>
	
	</channel>
	
	<channel name="EAD" execrate="8">
		
		<switch name="fadec/eng-1-powered">
			<default value="0"/>
			<test value="1">
				/engines/engine[0]/state eq 3
			</test>
			<test logic="AND" value="1">
				/systems/electrical/outputs/efis ge 25
				/engines/engine[0]/n2-actual ge 1
			</test>
		</switch>
		
		<switch name="fadec/eng-2-powered">
			<default value="0"/>
			<test value="1">
				/engines/engine[1]/state eq 3
			</test>
			<test logic="AND" value="1">
				/systems/electrical/outputs/efis ge 25
				/engines/engine[1]/n2-actual ge 1
			</test>
		</switch>
		
		<switch name="fadec/eng-3-powered">
			<default value="0"/>
			<test value="1">
				/engines/engine[2]/state eq 3
			</test>
			<test logic="AND" value="1">
				/systems/electrical/outputs/efis ge 25
				/engines/engine[2]/n2-actual ge 1
			</test>
		</switch>
	
	</channel>

</system>
